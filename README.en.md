# Mistnet Signaling Server

This is a signaling server for WebRTC applications. Implemented in Go, it helps clients (nodes) join a room and establish Peer-to-Peer connections with other clients in the same room.

## Features

- Real-time communication via WebSocket
- Room-based client management
- Automatic peer discovery and pairing requests upon joining a room
- Simple configuration via a `config.json` file
- Log rotation feature using `zap` and `lumberjack`

## Usage

### 1. Prerequisites

- Go (version 1.18 or higher is recommended) must be installed.

### 2. Build

Clone the repository and build the project with the following command:

```sh
go build
```

### 3. Configuration

When you run the server for the first time, a `config.json` file is automatically generated in the current directory.

```json
{
  "GlobalNode": {
    "Enable": true,
    "Port": 8080
  }
}
```

- **Enable**: If set to `true`, the server will start.
- **Port**: Specifies the port number for the server to listen on.

### 4. Running the Server

Launch the executable file generated by the build process:

```sh
./mistnet-signaling
```

The server will start on the port specified in `config.json` (default: 8080). Logs are written to `./logs/app.log`.

## Protocol Specification

### Endpoint

The signaling server provides the following WebSocket endpoint:

`ws://<server_address>:<port>/signaling`

### Message Format

Communication between clients and the server is performed using JSON messages in the following format:

```json
{
  "Type": "Request",
  "Data": "...",
  "SenderId": "node-id-of-sender",
  "ReceiverId": "node-id-of-receiver",
  "RoomId": "room-id"
}
```

- **Type**: The type of the message.
  - `Request`: Used when a client joins a room or when the server requests a client to initiate a P2P connection.
  - Others (e.g., `offer`, `answer`, `candidate`): These messages are forwarded by the server directly to the client specified in `ReceiverId`.
- **Data**: The message payload (e.g., SDP offer/answer, ICE candidate).
- **SenderId**: The unique ID of the client sending the message.
- **ReceiverId**: The unique ID of the client intended to receive the message. This field can be empty for a `Request` message sent to the server.
- **RoomId**: The ID of the room the client wishes to join.

### Communication Flow

1.  **Connection and Joining a Room**
    A client connects to the WebSocket endpoint and sends a message with `Type: "Request"` to join a room.

    **Client A -> Server:**
    ```json
    {
      "Type": "Request",
      "SenderId": "node-A",
      "RoomId": "room-123"
    }
    ```

2.  **Peer Pairing Request**
    When a new client joins a room, the server sends a `Type: "Request"` message to the relevant clients to encourage them to connect with the new peer. For example, if Client B joins the same room, the server will ask A and B to connect to each other.

    **Server -> Client A:**
    ```json
    {
      "Type": "Request",
      "SenderId": "node-B", // The ID of the peer to connect with
      "ReceiverId": "node-A",
      "RoomId": "room-123"
    }
    ```
    **Server -> Client B:**
    ```json
    {
      "Type": "Request",
      "SenderId": "node-A", // The ID of the peer to connect with
      "ReceiverId": "node-B",
      "RoomId": "room-123"
    }
    ```
    Upon receiving this message, the client should start the WebRTC connection process (e.g., creating an offer) with the peer specified in `SenderId`.

3.  **Forwarding WebRTC Signaling Messages**
    WebRTC signaling messages, such as SDP Offers/Answers or ICE Candidates, are sent to the server with a specified `ReceiverId`. The server forwards these messages directly to the corresponding client.

    **Client A -> Server (to forward an Offer):**
    ```json
    {
      "Type": "offer",
      "Data": "{ \"sdp\": \"...\" }",
      "SenderId": "node-A",
      "ReceiverId": "node-B",
      "RoomId": "room-123"
    }
    ```
    The server forwards this message to Client B.

4.  **Disconnection**
    When a client disconnects from the WebSocket, the server automatically removes it from the room.

## License

This project is released under the license described in the `LICENSE` file.
